apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: ceph-nfs-export-apply-homelab-nfs
  namespace: rook-ceph
spec:
  backoffLimit: 3
  template:
    spec:
      containers:
        - command:
            - /bin/bash
            - -lc
            - "set -euo pipefail\n\nCEPH_CONFIG=/etc/ceph/ceph.conf\nMON_CONFIG=/etc/rook/mon-endpoints\n\
              KEYRING_FILE=/etc/ceph/keyring\nendpoints=$(cat \"$MON_CONFIG\")\nmon_endpoints=$(echo\
              \ \"$endpoints\" | sed 's/[a-z0-9_-]\\+=//g')\nmkdir -p /etc/ceph\n\
              cat > \"$CEPH_CONFIG\" <<EOF\n[global]\nmon_host = $mon_endpoints\n\
              [client.admin]\nkeyring = $KEYRING_FILE\nEOF\nif   [ -f /var/lib/rook-ceph-mon/ceph-secret\
              \ ];  then ceph_secret=$(cat /var/lib/rook-ceph-mon/ceph-secret)\nelif\
              \ [ -f /var/lib/rook-ceph-mon/admin-secret ]; then ceph_secret=$(cat\
              \ /var/lib/rook-ceph-mon/admin-secret)\nelse echo \"No ceph admin secret\
              \ found\"; exit 2; fi\nif [ -f /var/lib/rook-ceph-mon/ceph-username\
              \ ]; then username=$(cat /var/lib/rook-ceph-mon/ceph-username); else\
              \ username=client.admin; fi\ncat > \"$KEYRING_FILE\" <<EOF\n[$username]\n\
              key = $ceph_secret\nEOF\n\nceph -c \"$CEPH_CONFIG\" mgr module enable\
              \ nfs || true\n\ncluster='homelab-nfs'\n\nceph -c \"$CEPH_CONFIG\" nfs\
              \ export apply \"$cluster\" -i /etc/ganesha/export.json\n\nns=\"$cluster\"\
              \nobj_conf=\"conf-nfs.$cluster\"\nobj_user=\"userconf-nfs.$cluster\"\
              \n\nrados -p .nfs -N \"$ns\" put \"$obj_user\" /etc/ganesha/userconf\n\
              \ntmp=$(mktemp)\nif rados -p .nfs -N \"$ns\" get \"$obj_conf\" \"$tmp\"\
              \ 2>/dev/null; then\n  if ! grep -q \"$obj_user\" \"$tmp\"; then\n \
              \   echo \"%url \\\"rados://.nfs/$ns/$obj_user\\\"\" >> \"$tmp\"\n \
              \   rados -p .nfs -N \"$ns\" put \"$obj_conf\" \"$tmp\"\n  fi\nelse\n\
              \  printf '%%url \"rados://.nfs/%s/%s\"\\n' \"$ns\" \"$obj_user\" >\
              \ \"$tmp\"\n  rados -p .nfs -N \"$ns\" put \"$obj_conf\" \"$tmp\"\n\
              fi\n\nhead -n 100 \"$tmp\" || true\n"
          image: quay.io/ceph/ceph:v19
          name: apply
          volumeMounts:
            - mountPath: /etc/rook
              name: mon-endpoints
            - mountPath: /etc/ceph
              name: ceph-config
            - mountPath: /var/lib/rook-ceph-mon
              name: ceph-admin-secret
              readOnly: true
            - mountPath: /etc/ganesha
              name: export
              readOnly: true
      restartPolicy: OnFailure
      serviceAccountName: rook-ceph-default
      volumes:
        - configMap:
            items:
              - key: data
                path: mon-endpoints
            name: rook-ceph-mon-endpoints
          name: mon-endpoints
        - emptyDir: {}
          name: ceph-config
        - name: ceph-admin-secret
          secret:
            secretName: rook-ceph-mon
        - configMap:
            name: ceph-nfs-export-homelab-nfs
          name: export
  ttlSecondsAfterFinished: 3600
---
apiVersion: ceph.rook.io/v1
kind: CephNFS
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: homelab-nfs
  namespace: rook-ceph
spec:
  server:
    active: 2
    placement:
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/control-plane
          operator: Exists
    resources:
      limits:
        memory: 512Mi
      requests:
        cpu: 50m
        memory: 64Mi
---
apiVersion: v1
data:
  export.json: '{"access_type":"RW","clients":[{"access_type":"RW","addresses":["10.10.10.0/24"],"squash":"no_root_squash"}],"fsal":{"fs_name":"ceph-filesystem","name":"CEPH"},"path":"/","protocols":[4],"pseudo":"/homelab","security_label":false,"squash":"no_root_squash","transports":["TCP"]}'
  userconf: "NFSv4 {\n  Minor_Versions = 0,1,2;\n  Delegations = false;\n  RecoveryBackend\
    \ = rados_cluster;\n}\n"
kind: ConfigMap
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: ceph-nfs-export-homelab-nfs
  namespace: rook-ceph
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
    lbipam.cilium.io/ips: 10.10.10.150
  name: homelab-nfs
  namespace: rook-ceph
spec:
  externalTrafficPolicy: Cluster
  ports:
    - name: nfs
      port: 2049
      protocol: TCP
      targetPort: 2049
    - name: nfs-udp
      port: 2049
      protocol: UDP
      targetPort: 2049
  selector:
    app: rook-ceph-nfs
    ceph_daemon_type: nfs
  type: LoadBalancer
