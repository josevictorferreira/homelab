apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/controller: main
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw-nix
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-nix
  namespace: apps
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/controller: main
      app.kubernetes.io/instance: openclaw-nix
      app.kubernetes.io/name: openclaw-nix
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        checksum/configMaps: cacf793c53d8637984dc8c269cd0e6c96c6ac64cc2246166a34ff3b438566e28
      labels:
        app.kubernetes.io/controller: main
        app.kubernetes.io/instance: openclaw-nix
        app.kubernetes.io/name: openclaw-nix
    spec:
      automountServiceAccountToken: true
      containers:
        - command:
            - bash
            - -c
            - "set -e\n\n# Ensure persistent directories exist for npm/pip packages\n\
              mkdir -p /home/node/.npm-global/bin\nmkdir -p /home/node/.local/lib/python\n\
              mkdir -p /home/node/.local/bin\nmkdir -p /home/node/.config\nmkdir -p\
              \ /home/node/.openclaw\n\n# Seed config from ConfigMap template if CephFS\
              \ file doesn't exist yet\nCONFIG_FILE=\"/home/node/.openclaw/openclaw.json\"\
              \nif [ ! -f \"$CONFIG_FILE\" ]; then\n  echo \"First run: seeding config\
              \ from template...\"\n  cp /etc/openclaw/config-template.json \"$CONFIG_FILE\"\
              \n  # Substitute secret env vars into the seeded config\n  for var in\
              \ OPENCLAW_MATRIX_TOKEN ELEVENLABS_API_KEY MOONSHOT_API_KEY OPENROUTER_API_KEY\
              \ KIMI_API_KEY MINIMAX_API_KEY WHATSAPP_NUMBER WHATSAPP_BOT_NUMBER GEMINI_API_KEY\
              \ GITHUB_TOKEN TS_AUTHKEY; do\n    val=$(printenv \"$var\" 2>/dev/null\
              \ || true)\n    if [ -n \"$val\" ]; then\n      pattern=$(printf '\\\
              x24{%s}' \"$var\")\n      sed -i \"s|$pattern|$val|g\" \"$CONFIG_FILE\"\
              \n    fi\n  done\n  echo \"Config seeded at $CONFIG_FILE\"\nelse\n \
              \ echo \"Using existing config at $CONFIG_FILE\"\nfi\n\necho \"Installing\
              \ matrix plugin dependencies...\"\n\n# Find the actual nix store path\
              \ where the gateway loads extensions from\nMATRIX_EXT=$(readlink -f\
              \ /lib/openclaw/extensions/matrix 2>/dev/null || echo \"/lib/openclaw/extensions/matrix\"\
              )\n\nif [ -d \"$MATRIX_EXT\" ]; then\n  echo \"Found matrix extension\
              \ at: $MATRIX_EXT\"\n  cd \"$MATRIX_EXT\"\n\n  if [ ! -d \"node_modules/@vector-im\"\
              \ ]; then\n    echo \"Installing npm dependencies...\"\n    node -e\
              \ \"\n      const fs = require('fs');\n      const pkg = JSON.parse(fs.readFileSync('package.json',\
              \ 'utf8'));\n      delete pkg.devDependencies;\n      fs.writeFileSync('package.json',\
              \ JSON.stringify(pkg, null, 2));\n    \"\n    npm install --omit=dev\
              \ --no-package-lock --legacy-peer-deps 2>&1 || echo \"WARN: npm install\
              \ failed\"\n    echo \"Matrix plugin dependencies installed\"\n  else\n\
              \    echo \"node_modules already exists with deps, skipping\"\n  fi\n\
              else\n  echo \"Matrix extension not found at $MATRIX_EXT\"\nfi\n\necho\
              \ \"Starting openclaw gateway...\"\nexec openclaw gateway --port 18789\n"
          env:
            - name: COPILOTGITHUBTOKEN
              valueFrom:
                secretKeyRef:
                  key: COPILOTGITHUBTOKEN
                  name: openclaw-config
            - name: COPILOT_GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  key: COPILOT_GITHUB_TOKEN
                  name: openclaw-config
            - name: ELEVENLABS_API_KEY
              valueFrom:
                secretKeyRef:
                  key: ELEVENLABS_API_KEY
                  name: openclaw-config
            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  key: GEMINI_API_KEY
                  name: openclaw-config
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  key: GITHUB_TOKEN
                  name: openclaw-config
            - name: HOME
              value: /home/node
            - name: KIMI_API_KEY
              valueFrom:
                secretKeyRef:
                  key: KIMI_API_KEY
                  name: openclaw-config
            - name: MINIMAX_API_KEY
              valueFrom:
                secretKeyRef:
                  key: MINIMAX_API_KEY
                  name: openclaw-config
            - name: NODE_PATH
              value: /lib/openclaw/extensions/matrix/node_modules
            - name: NPM_CONFIG_PREFIX
              value: /home/node/.npm-global
            - name: OPENCLAW_CONFIG_PATH
              value: /home/node/.openclaw/openclaw.json
            - name: OPENCLAW_DATA_DIR
              value: /home/node/.openclaw
            - name: OPENCLAW_MATRIX_TOKEN
              valueFrom:
                secretKeyRef:
                  key: OPENCLAW_MATRIX_TOKEN
                  name: openclaw-config
            - name: OPENCLAW_STATE_DIR
              value: /home/node/.openclaw
            - name: OPENROUTER_API_KEY
              valueFrom:
                secretKeyRef:
                  key: OPENROUTER_API_KEY
                  name: openclaw-config
            - name: PATH
              value: /home/node/.local/bin:/home/node/.npm-global/bin:/bin:/usr/bin
            - name: PIP_TARGET
              value: /home/node/.local/lib/python
            - name: PYTHONPATH
              value: /home/node/.local/lib/python
            - name: TZ
              value: America/Sao_Paulo
            - name: Z_AI_API_KEY
              valueFrom:
                secretKeyRef:
                  key: Z_AI_API_KEY
                  name: openclaw-config
          envFrom:
            - secretRef:
                name: openclaw-config
          image: ghcr.io/josevictorferreira/openclaw-nix:v2026.2.26
          imagePullPolicy: Always
          name: main
          ports:
            - containerPort: 18789
              name: http
              protocol: TCP
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /etc/openclaw/config-template.json
              name: config
              readOnly: true
              subPath: config-template.json
            - mountPath: /home/node
              name: shared-storage
              subPath: openclaw-home
            - mountPath: /home/node/.openclaw
              name: shared-storage
              subPath: openclaw
            - mountPath: /home/node/shared
              name: shared-storage
        - env:
            - name: TS_ACCEPT_DNS
              value: 'false'
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  key: TS_AUTHKEY
                  name: openclaw-config
            - name: TS_AUTH_ONCE
              value: 'true'
            - name: TS_HOSTNAME
              value: openclaw-nix
            - name: TS_KUBE_SECRET
              value: ''
            - name: TS_STATE_DIR
              value: /var/lib/tailscale
            - name: TS_USERSPACE
              value: 'false'
          image: tailscale/tailscale:latest
          name: tailscale
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /etc/openclaw/config-template.json
              name: config
              readOnly: true
              subPath: config-template.json
            - mountPath: /dev/net/tun
              name: dev-tun
            - mountPath: /var/lib/tailscale
              name: tailscale-state
      dnsConfig:
        nameservers:
          - 10.43.0.10
          - 100.100.100.100
        options:
          - name: ndots
            value: '5'
        searches:
          - apps.svc.cluster.local
          - svc.cluster.local
          - cluster.local
      dnsPolicy: None
      enableServiceLinks: false
      hostIPC: false
      hostNetwork: false
      hostPID: false
      imagePullSecrets:
        - name: ghcr-registry-secret
      serviceAccountName: openclaw-nix
      volumes:
        - configMap:
            items:
              - key: config-template.json
                path: config-template.json
            name: openclaw-nix
          name: config
        - hostPath:
            path: /dev/net/tun
          name: dev-tun
        - name: shared-storage
          persistentVolumeClaim:
            claimName: cephfs-shared-storage-root
        - name: tailscale-state
          persistentVolumeClaim:
            claimName: openclaw-nix
---
apiVersion: v1
data:
  config-template.json: '{"agents":{"defaults":{"compaction":{"memoryFlush":{"enabled":true,"prompt":"Write
    any lasting notes to memory/YYYY-MM-DD.md; reply with NO_REPLY if nothing to store.","softThresholdTokens":4000,"systemPrompt":"Session
    nearing compaction. Store durable memories now."},"reserveTokensFloor":20000},"contextPruning":{"mode":"cache-ttl","ttl":"30m"},"imageModel":{"fallbacks":["kimi-coding/k2p5"],"primary":"github-copilot/gemini-3-flash-preview"},"memorySearch":{"experimental":{"sessionMemory":true},"model":"gemini-embedding-001","provider":"gemini","sources":["memory","sessions"]},"model":{"fallbacks":["kimi-coding/k2p5","zai-coding-plan/glm-5","minimax/MiniMax-M2.5"],"primary":"github-copilot/claude-opus-4.6"},"subagents":{"archiveAfterMinutes":60,"maxConcurrent":4,"model":"zai-coding-plan/glm-5","runTimeoutSeconds":900},"timeoutSeconds":600,"userTimezone":"America/Sao_Paulo","workspace":"/home/node/.openclaw/workspace"},"list":[{"id":"main","identity":{"emoji":"üêï","name":"Mel","theme":"minha
    fiel assistente"}}]},"channels":{"matrix":{"accessToken":"${OPENCLAW_MATRIX_TOKEN}","autoJoin":"allowlist","autoJoinAllowList":["@jose:josevictor.me","@admin:josevictor.me","@zeh:josevictor.me"],"dm":{"allowFrom":["@jose:josevictor.me","@admin:josevictor.me","@zeh:josevictor.me"],"policy":"allowlist"},"enabled":true,"encryption":false,"groupPolicy":"disabled","homeserver":"http://synapse-matrix-synapse:8008","mediaMaxMb":150,"userId":"@openclaw:josevictor.me"},"whatsapp":{"ackReaction":{"direct":true,"emoji":"üëÄ","group":"mentions"},"allowFrom":["${WHATSAPP_NUMBER}"],"dmPolicy":"allowlist","enabled":true,"groupAllowFrom":["${WHATSAPP_NUMBER}"],"groupPolicy":"allowlist"}},"env":{"COPILOT_GITHUB_TOKEN":"${COPILOT_GITHUB_TOKEN}","ELEVENLABS_API_KEY":"${ELEVENLABS_API_KEY}","MOONSHOT_API_KEY":"${MOONSHOT_API_KEY}","OPENROUTER_API_KEY":"${OPENCLAW_MATRIX_TOKEN}"},"gateway":{"bind":"lan","controlUi":{"dangerouslyAllowHostHeaderOriginFallback":true},"mode":"local","port":18789},"logging":{"level":"debug"},"messages":{"tts":{"auto":"inbound","elevenlabs":{"apiKey":"${ELEVENLABS_API_KEY}","modelId":"eleven_v3","seed":91,"voiceId":"GOkMqfyKMLVUcYfO2WbB","voiceSettings":{"similarityBoost":0.75,"speed":1.0,"stability":0.5,"style":0.0,"useSpeakerBoost":true}},"provider":"elevenlabs","summaryModel":"kimi-coding/k2p5"}},"models":{"mode":"merge","providers":{"kimi-coding":{"api":"anthropic-messages","apiKey":"${MOONSHOT_API_KEY}","baseUrl":"https://api.kimi.com/coding","models":[{"contextWindow":256000,"id":"k2p5","input":["text"],"maxTokens":8192,"name":"Kimi
    K2.5","reasoning":false}]},"minimax":{"api":"anthropic-messages","apiKey":"${MINIMAX_API_KEY}","baseUrl":"https://api.minimaxi.com/anthropic","models":[{"contextWindow":200000,"cost":{"cacheRead":2,"cacheWrite":10,"input":15,"output":60},"id":"MiniMax-M2.5","input":["text"],"maxTokens":8192,"name":"MiniMax
    M2.5","reasoning":true}]},"zai-coding-plan":{"api":"anthropic-messages","apiKey":"${Z_AI_API_KEY}","baseUrl":"https://api.z.ai/api/anthropic","models":[{"contextWindow":120000,"id":"glm-5","input":["text"],"maxTokens":8192,"name":"GLM-5","reasoning":true}]}}},"plugins":{"allow":["matrix","whatsapp","memory-core"],"slots":{"memory":"memory-core"}},"session":{"idleMinutes":60,"reset":{"atHour":4,"mode":"daily"},"scope":"per-sender"},"talk":{"apiKey":"${ELEVENLABS_API_KEY}","interruptOnSpeech":true,"modelId":"eleven_v3","outputFormat":"mp3_44100_128","voiceId":"GOkMqfyKMLVUcYfO2WbB"},"tools":{"allow":["exec","read","write","edit","process","web_search","web_fetch","canvas","nodes","image","message","gateway","browser","cron","browser","sessions_list","sessions_history","sessions_send","sessions_spawn","session_status","agents_list"],"deny":[],"media":{"audio":{"enabled":true,"models":[{"args":["-c","curl
    -s -X POST https://api.elevenlabs.io/v1/speech-to-text -H \"xi-api-key: ${ELEVENLABS_API_KEY}\"
    -F model_id=scribe_v2 -F \"file=@{{MediaPath}}\" -F tag_audio_events=true -F language_code=por
    | jq -r .text"],"command":"sh","type":"cli"}]},"concurrency":2,"video":{"enabled":true,"maxBytes":52428800,"models":[{"model":"gemini-3-flash-preview","provider":"github-copilot"}]}},"web":{"search":{"perplexity":{"apiKey":"${OPENROUTER_API_KEY}","baseUrl":"https://openrouter.ai/api/v1","model":"perplexity/sonar-pro"},"provider":"perplexity"}}}}'
kind: ConfigMap
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw-nix
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-nix
  namespace: apps
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw-nix
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-nix
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-ceph-block
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
    lbipam.cilium.io/ips: 10.10.10.141
    lbipam.cilium.io/sharing-key: openclaw-nix
  labels:
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw-nix
    app.kubernetes.io/service: openclaw-nix
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-nix
  namespace: apps
spec:
  ports:
    - name: http
      port: 18789
      protocol: TCP
      targetPort: 18789
  selector:
    app.kubernetes.io/controller: main
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/name: openclaw-nix
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: cloudflare-issuer
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw-nix
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw-nix
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-nix
  namespace: apps
spec:
  ingressClassName: cilium
  rules:
    - host: openclaw.josevictor.me
      http:
        paths:
          - backend:
              service:
                name: openclaw-nix
                port:
                  number: 18789
            path: /
            pathType: Prefix
  tls:
    - hosts:
        - openclaw.josevictor.me
      secretName: wildcard-tls
---
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: openclaw-nix
  namespace: apps
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: openclaw-nix-cluster-admin
rules:
  - apiGroups:
      - '*'
    resources:
      - '*'
    verbs:
      - '*'
  - nonResourceURLs:
      - '*'
    verbs:
      - '*'
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: openclaw-nix-cluster-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: openclaw-nix-cluster-admin
subjects:
  - kind: ServiceAccount
    name: openclaw-nix
    namespace: apps
