apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/controller: main
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw
  namespace: apps
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/controller: main
      app.kubernetes.io/instance: openclaw
      app.kubernetes.io/name: openclaw
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        checksum/configMaps: 1e5db2ec8badb2237db0742198337e64ad2f0f9e3b213767d9bd33356fb4932d
      labels:
        app.kubernetes.io/controller: main
        app.kubernetes.io/instance: openclaw
        app.kubernetes.io/name: openclaw
    spec:
      automountServiceAccountToken: true
      containers:
        - command:
            - sh
            - -c
            - "echo \"Installing matrix plugin deps into extension dir...\"\ncd /app/extensions/matrix\n\
              # Strip workspace: protocol deps that npm can't handle, using node for\
              \ valid JSON\nnode -e \"\n  const fs = require('fs');\n  const pkg =\
              \ JSON.parse(fs.readFileSync('package.json', 'utf8'));\n  delete pkg.devDependencies;\n\
              \  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));\n\
              \"\nnpm install --omit=dev --no-package-lock --legacy-peer-deps 2>&1\
              \ || echo \"WARN: npm install in extension dir failed\"\necho \"Ensuring\
              \ matrix plugin is enabled in config...\"\ncd /app\nnode -e \"\n  const\
              \ fs = require('fs');\n  const cfgPath = '/home/node/.openclaw/openclaw.json';\n\
              \  const cfg = JSON.parse(fs.readFileSync(cfgPath, 'utf8'));\n  if (!cfg.plugins)\
              \ cfg.plugins = {};\n  if (!cfg.plugins.entries) cfg.plugins.entries\
              \ = {};\n  if (!cfg.plugins.entries.matrix) cfg.plugins.entries.matrix\
              \ = {};\n  cfg.plugins.entries.matrix.enabled = true;\n  if (!cfg.plugins.allow)\
              \ cfg.plugins.allow = [];\n  if (!cfg.plugins.allow.includes('matrix'))\
              \ cfg.plugins.allow.push('matrix');\n  fs.writeFileSync(cfgPath, JSON.stringify(cfg,\
              \ null, 2));\n  console.log('Config updated: matrix plugin enabled');\n\
              \"\necho \"Starting gateway...\"\nexec node dist/index.js gateway run\
              \ --allow-unconfigured\n"
          env:
            - name: ELEVENLABS_API_KEY
              valueFrom:
                secretKeyRef:
                  key: elevenlabs_api_key
                  name: openclaw-secrets
            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  key: GEMINI_API_KEY
                  name: openclaw-secrets
            - name: HOME
              value: /home/node
            - name: KIMI_API_KEY
              valueFrom:
                secretKeyRef:
                  key: KIMI_API_KEY
                  name: openclaw-secrets
            - name: MINIMAX_API_KEY
              valueFrom:
                secretKeyRef:
                  key: MINIMAX_API_KEY
                  name: openclaw-secrets
            - name: OPENCLAW_MATRIX_TOKEN
              valueFrom:
                secretKeyRef:
                  key: OPENCLAW_MATRIX_TOKEN
                  name: openclaw-secrets
            - name: OPENROUTER_API_KEY
              valueFrom:
                secretKeyRef:
                  key: OPENROUTER_API_KEY
                  name: openclaw-secrets
            - name: PATH
              value: /home/node/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
            - name: XDG_CONFIG_HOME
              value: /home/node/.config
          envFrom:
            - secretRef:
                name: openclaw-secrets
          image: ghcr.io/openclaw/openclaw:2026.2.14@sha256:ace6f32961c4d574cb189d0007ec778408a9c02502f38af9ded6c864bae0f454
          imagePullPolicy: IfNotPresent
          name: main
          ports:
            - containerPort: 18789
              name: http
              protocol: TCP
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /config/openclaw.json
              name: config
              readOnly: true
              subPath: openclaw.json
            - mountPath: /home/node
              name: main
            - mountPath: /home/node/shared
              name: shared-storage
        - env:
            - name: TS_ACCEPT_DNS
              value: 'false'
            - name: TS_AUTHKEY
              valueFrom:
                secretKeyRef:
                  key: TS_AUTHKEY
                  name: openclaw-secrets
            - name: TS_AUTH_ONCE
              value: 'true'
            - name: TS_HOSTNAME
              value: openclaw
            - name: TS_KUBE_SECRET
              value: ''
            - name: TS_STATE_DIR
              value: /var/lib/tailscale
            - name: TS_USERSPACE
              value: 'false'
          image: tailscale/tailscale:latest
          name: tailscale
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /config/openclaw.json
              name: config
              readOnly: true
              subPath: openclaw.json
            - mountPath: /dev/net/tun
              name: dev-tun
            - mountPath: /home/node
              name: main
            - mountPath: /var/lib/tailscale
              name: tailscale-state
      dnsConfig:
        nameservers:
          - 10.43.0.10
          - 100.100.100.100
        options:
          - name: ndots
            value: '5'
        searches:
          - apps.svc.cluster.local
          - svc.cluster.local
          - cluster.local
      dnsPolicy: None
      enableServiceLinks: false
      hostIPC: false
      hostNetwork: false
      hostPID: false
      initContainers:
        - command:
            - sh
            - -c
            - mkdir -p /home/node/.openclaw && cp /config/openclaw.json /home/node/.openclaw/openclaw.json
              && rm -rf /home/node/.openclaw/extensions /home/node/.config/openclaw/extensions
          image: busybox:latest
          name: copy-config
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /config/openclaw.json
              name: config
              readOnly: true
              subPath: openclaw.json
            - mountPath: /home/node
              name: main
        - command:
            - bash
            - -c
            - "        set -e\n        mkdir -p /home/node/.local/bin\n        chown\
              \ -R 1000:1000 /home/node/.local\n\n        # Install curl first (needed\
              \ for all downloads)\n        apt-get update && apt-get install -y curl\
              \ xz-utils\n\n        # Install ffmpeg\n        if [ ! -f /home/node/.local/bin/ffmpeg\
              \ ]; then\n          echo \"Installing ffmpeg...\"\n          # Download\
              \ from John Van Sickle (reliable static builds)\n          curl -fsSL\
              \ -o /tmp/ffmpeg.tar.xz \"https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz\"\
              \n          tar -xf /tmp/ffmpeg.tar.xz -C /tmp/\n          # Find the\
              \ ffmpeg binary in the extracted folder (it's usually in a subdirectory)\n\
              \          find /tmp -name \"ffmpeg\" -type f -executable | head -1\
              \ | xargs -I {} cp {} /home/node/.local/bin/ffmpeg\n          chmod\
              \ +x /home/node/.local/bin/ffmpeg\n          rm -rf /tmp/ffmpeg.tar.xz\
              \ /tmp/ffmpeg*\n          echo \"ffmpeg installed successfully\"\n \
              \       else\n          echo \"ffmpeg already exists, skipping...\"\n\
              \        fi\n\n        # Install uv\n        if [ ! -f /home/node/.local/bin/uv\
              \ ]; then\n          echo \"Installing uv...\"\n          curl -fsSL\
              \ https://astral.sh/uv/install.sh | UV_INSTALL_DIR=/home/node/.local/bin\
              \ sh\n          echo \"uv installed successfully\"\n        else\n \
              \         echo \"uv already exists, skipping...\"\n        fi\n\n  \
              \      # Install Gemini CLI\n        if [ ! -f /home/node/.local/bin/gemini\
              \ ]; then\n          echo \"Installing Gemini CLI...\"\n          #\
              \ Install locally - npm creates lib/ inside prefix\n          mkdir\
              \ -p /home/node/.local/lib/node_modules\n          npm install @google/gemini-cli\
              \ --prefix /home/node/.local\n          # Create symlink to the binary\
              \ (npm puts it in prefix/lib/node_modules/.bin/)\n          ln -sf /home/node/.local/lib/node_modules/.bin/gemini\
              \ /home/node/.local/bin/gemini\n          echo \"Gemini CLI installed\
              \ successfully\"\n        else\n          echo \"Gemini CLI already\
              \ exists, skipping...\"\n        fi\n\n# Install whisper.cpp (compile\
              \ from source since no binaries available)\nif [ ! -f /home/node/.local/bin/whisper\
              \ ]; then\n  echo \"Installing whisper.cpp...\"\n  apt-get update &&\
              \ apt-get install -y git build-essential\n  cd /tmp\n  git clone --depth\
              \ 1 https://github.com/ggerganov/whisper.cpp.git\n  cd whisper.cpp\n\
              \  make -j$(nproc)\n  cp main /home/node/.local/bin/whisper\n  cd /\n\
              \  rm -rf /tmp/whisper.cpp\nfi\n\n        # Download whisper model if\
              \ not exists\n        mkdir -p /home/node/.local/share/whisper\n   \
              \     if [ ! -f /home/node/.local/share/whisper/ggml-base.bin ]; then\n\
              \          echo \"Downloading whisper base model...\"\n          curl\
              \ -fsSL -o /home/node/.local/share/whisper/ggml-base.bin \"https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin\"\
              \n          echo \"Whisper base model downloaded successfully\"\n  \
              \      else\n          echo \"Whisper base model already exists, skipping...\"\
              \n        fi\n\n        # Set ownership\n        chown -R 1000:1000\
              \ /home/node/.local\n        ls -la /home/node/.local/bin/\n       \
              \ echo \"All tools installed successfully!\"\n"
          image: node:22-slim
          name: install-tools
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /config/openclaw.json
              name: config
              readOnly: true
              subPath: openclaw.json
            - mountPath: /home/node
              name: main
      serviceAccountName: default
      volumes:
        - configMap:
            items:
              - key: openclaw.json
                path: openclaw.json
            name: openclaw
          name: config
        - hostPath:
            path: /dev/net/tun
          name: dev-tun
        - name: main
          persistentVolumeClaim:
            claimName: openclaw-main
        - name: shared-storage
          persistentVolumeClaim:
            claimName: cephfs-shared-storage-root
        - name: tailscale-state
          persistentVolumeClaim:
            claimName: openclaw-tailscale-state
---
apiVersion: v1
data:
  openclaw.json: '{"agents":{"defaults":{"model":{"primary":"kimi-coding/k2p5"},"timeoutSeconds":600,"userTimezone":"America/Sao_Paulo","workspace":"/home/node/.openclaw/workspace"},"list":[{"id":"main","identity":{"emoji":"ðŸ¦ž","name":"Clawd","theme":"helpful
    AI assistant"}}]},"channels":{"matrix":{"accessToken":"${OPENCLAW_MATRIX_TOKEN}","autoJoin":"allowlist","autoJoinAllowList":["@jose:josevictor.me","@admin:josevictor.me","@zeh:josevictor.me"],"dm":{"allowFrom":["@jose:josevictor.me","@admin:josevictor.me","@zeh:josevictor.me"],"policy":"allowlist"},"enabled":true,"encryption":false,"groupPolicy":"disabled","homeserver":"http://synapse-matrix-synapse:8008","mediaMaxMb":150,"userId":"@openclaw:josevictor.me"}},"env":{"MOONSHOT_API_KEY":"${MOONSHOT_API_KEY}"},"gateway":{"bind":"lan","mode":"local","port":18789},"logging":{"level":"info"},"models":{"mode":"merge","providers":{"kimi-coding":{"api":"anthropic-messages","apiKey":"${MOONSHOT_API_KEY}","baseUrl":"https://api.kimi.com/coding","models":[{"contextWindow":256000,"id":"k2p5","input":["text"],"maxTokens":8192,"name":"Kimi
    K2.5","reasoning":false}]}}},"plugins":{"allow":["matrix"]},"session":{"idleMinutes":60,"reset":{"atHour":4,"mode":"daily"},"scope":"per-sender"},"tools":{"allow":["exec","read","write","edit","process","web_search","web_fetch","canvas","nodes","message","cron","gateway","browser","sessions_list","sessions_history","sessions_send","sessions_spawn","session_status","agents_list"],"deny":[],"media":{"audio":{"enabled":true,"maxBytes":20971520,"models":[{"args":["--model","/home/node/.local/share/whisper/ggml-base.bin","{{MediaPath}}"],"command":"whisper","timeoutSeconds":45,"type":"cli"}]}}}}'
kind: ConfigMap
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw
  namespace: apps
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-main
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: rook-ceph-block
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw-tailscale-state
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: rook-ceph-block
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
    lbipam.cilium.io/ips: 10.10.10.140
    lbipam.cilium.io/sharing-key: openclaw
  labels:
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: openclaw
    app.kubernetes.io/service: openclaw
    helm.sh/chart: app-template-4.2.0
    kubenix/module-name: release
    kubenix/module-version: 1.0.0
  name: openclaw
  namespace: apps
spec:
  ports:
    - name: http
      port: 18789
      protocol: TCP
      targetPort: 18789
  selector:
    app.kubernetes.io/controller: main
    app.kubernetes.io/instance: openclaw
    app.kubernetes.io/name: openclaw
  type: LoadBalancer
