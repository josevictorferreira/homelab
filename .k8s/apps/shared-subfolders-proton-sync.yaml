apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-proton-sync
  namespace: apps
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600
      backoffLimit: 2
      template:
        spec:
          containers:
            - args:
                - "set -euo pipefail\n\necho \"=== Proton Drive Sync: MinIO â†’ Proton\
                  \ ===\"\necho \"Date: $(date -Iseconds)\"\necho \"Source: $MINIO_BUCKET\"\
                  \necho \"Dest: $PROTON_DEST_PATH\"\n\n# Check if authenticated (credentials.enc\
                  \ exists)\nif [ ! -f /config/proton-drive-sync/credentials.enc ];\
                  \ then\n  echo \"ERROR: Not authenticated. Run auth job first.\"\
                  \n  echo \"kubectl create job --from=cronjob/shared-subfolders-proton-sync\
                  \ shared-subfolders-proton-sync-manual -n apps\"\n  exit 1\nfi\n\
                  \n# Install rclone for MinIO access\napk add --no-cache rclone zstd\
                  \ curl\n\n# Configure rclone for MinIO\nmkdir -p ~/.config/rclone\n\
                  cat > ~/.config/rclone/rclone.conf << EOF\n[minio]\ntype = s3\n\
                  provider = Minio\nenv_auth = false\naccess_key_id = \\${MINIO_ACCESS_KEY_ID}\n\
                  secret_access_key = \\${MINIO_SECRET_ACCESS_KEY}\nendpoint = $MINIO_URL\n\
                  \n[proton]\ntype = protondrive\nusername = $PROTON_USERNAME\npassword\
                  \ = $PROTON_PASSWORD\nEOF\n\n# Get today's date\nTODAY=$(date +%Y-%m-%d)\n\
                  YEAR=$(date +%Y)\nMONTH=$(date +%m)\nDAY=$(date +%d)\n\necho \"\"\
                  \necho \"=== Syncing archives for $TODAY ===\"\n\n# List files in\
                  \ MinIO bucket for today\necho \"Listing MinIO objects...\"\nrclone\
                  \ ls minio:$MINIO_BUCKET/$YEAR/$MONTH/$DAY/ 2>/dev/null || echo\
                  \ \"No objects found for today\"\n\n# Sync to Proton Drive using\
                  \ proton-drive-sync\n# First, mount/sync via rclone to a temp dir,\
                  \ then use proton-drive-sync\nSYNC_DIR=/tmp/proton-sync-$TODAY\n\
                  mkdir -p $SYNC_DIR\n\n# Copy today's archives from MinIO\necho \"\
                  \"\necho \"=== Downloading from MinIO ===\"\nrclone copy minio:$MINIO_BUCKET/$YEAR/$MONTH/$DAY/\
                  \ $SYNC_DIR/ --progress || true\n\nif [ -z \"$(ls -A $SYNC_DIR 2>/dev/null)\"\
                  \ ]; then\n  echo \"WARNING: No archives found in MinIO for $TODAY\"\
                  \n  exit 0\nfi\n\n# List files to sync\necho \"\"\necho \"=== Files\
                  \ to sync ===\"\nls -la $SYNC_DIR/\n\n# Create sync config for proton-drive-sync\n\
                  mkdir -p /tmp/proton-config\ncat > /tmp/proton-config/sync.json\
                  \ << EOF\n{\n  \"syncs\": [\n    {\n      \"localPath\": \"$SYNC_DIR\"\
                  ,\n      \"remotePath\": \"$PROTON_DEST_PATH/$YEAR/$MONTH/$DAY\"\
                  ,\n      \"direction\": \"up\"\n    }\n  ]\n}\nEOF\n\n# Run proton-drive-sync\n\
                  echo \"\"\necho \"=== Syncing to Proton Drive ===\"\ncd /tmp/proton-config\n\
                  proton-drive-sync sync --config ./sync.json || {\n  echo \"WARNING:\
                  \ Proton sync had errors (best-effort)\"\n}\n\n# Generate report\n\
                  echo \"\"\necho \"=== Generating sync report ===\"\nREPORT_FILE=\"\
                  /tmp/proton-sync-report-$TODAY.json\"\ncat > $REPORT_FILE << EOF\n\
                  {\n  \"timestamp\": \"$(date -Iseconds)\",\n  \"date\": \"$TODAY\"\
                  ,\n  \"source_bucket\": \"$MINIO_BUCKET\",\n  \"source_prefix\"\
                  : \"$YEAR/$MONTH/$DAY\",\n  \"destination_path\": \"$PROTON_DEST_PATH/$YEAR/$MONTH/$DAY\"\
                  ,\n  \"files_synced\": $(ls -1 $SYNC_DIR 2>/dev/null | wc -l),\n\
                  \  \"status\": \"completed\"\n}\nEOF\n\ncat $REPORT_FILE\n\n# Upload\
                  \ report back to MinIO\necho \"\"\necho \"=== Uploading report to\
                  \ MinIO ===\"\nexport MC_HOST_minio=\"$MINIO_URL\"\nmc cp $REPORT_FILE\
                  \ minio/$MINIO_BUCKET/_reports/$YEAR/$MONTH/$DAY/proton-sync-report.json\
                  \ || true\n\n# Cleanup\nrm -rf $SYNC_DIR\n\necho \"\"\necho \"===\
                  \ Sync complete ===\"\n"
              command:
                - sh
                - -c
              env:
                - name: KEYRING_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: KEYRING_PASSWORD
                      name: shared-subfolders-proton-sync-config
                - name: PROTON_USERNAME
                  valueFrom:
                    secretKeyRef:
                      key: PROTON_USERNAME
                      name: shared-subfolders-proton-sync-config
                - name: PROTON_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: PROTON_PASSWORD
                      name: shared-subfolders-proton-sync-config
                - name: TZ
                  value: America/Sao_Paulo
                - name: MINIO_URL
                  value: http://10.10.10.209:9000
                - name: MINIO_BUCKET
                  value: homelab-backup-shared
                - name: PROTON_DEST_PATH
                  value: /Backups/homelab/shared-archives
              image: ghcr.io/damianb-bitflipper/proton-drive-sync:latest
              name: shared-subfolders-proton-sync
              resources:
                limits:
                  cpu: 1000m
                  ephemeral-storage: 10Gi
                  memory: 1Gi
                requests:
                  cpu: 100m
                  ephemeral-storage: 2Gi
                  memory: 256Mi
              volumeMounts:
                - mountPath: /config/proton-drive-sync
                  name: proton-config
                - mountPath: /state/proton-drive-sync
                  name: proton-state
          restartPolicy: Never
          volumes:
            - name: proton-config
              persistentVolumeClaim:
                claimName: shared-subfolders-proton-sync-config
            - name: proton-state
              persistentVolumeClaim:
                claimName: shared-subfolders-proton-sync-state
  schedule: 0 3 * * *
  timeZone: America/Sao_Paulo
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-proton-sync-config
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: longhorn
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-proton-sync-state
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: longhorn
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-proton-sync
  namespace: apps
spec:
  ports:
    - name: dashboard
      port: 4242
      targetPort: 4242
  selector:
    app: shared-subfolders-proton-sync
