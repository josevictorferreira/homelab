apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: synapse
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: synapse
      app.kubernetes.io/instance: synapse
      app.kubernetes.io/name: matrix-synapse
  strategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        checksum/config: 618844adc5b3f88ba7f8aeabf0cd12715167626f7fcf0a1659ef83d8d02e220d
        checksum/secrets: 5965a9801f0e11e306b9bbe4e80d3ed9888963861fab190e27a2b4a8e63047d5
      labels:
        app.kubernetes.io/component: synapse
        app.kubernetes.io/instance: synapse
        app.kubernetes.io/name: matrix-synapse
    spec:
      containers:
        - command:
            - sh
            - -c
            - "export POSTGRES_PASSWORD=$(echo \"${POSTGRES_PASSWORD:-}\" | sed 's/\\\
              //\\\\\\//g' | sed 's/\\&/\\\\\\&/g') && \\\nexport REDIS_PASSWORD=$(echo\
              \ \"${REDIS_PASSWORD:-}\" | sed 's/\\//\\\\\\//g' | sed 's/\\&/\\\\\\\
              &/g') && \\\ncat /synapse/secrets/*.yaml | \\\n  sed -e \"s/@@POSTGRES_PASSWORD@@/${POSTGRES_PASSWORD:-}/\"\
              \ \\\n      -e \"s/@@REDIS_PASSWORD@@/${REDIS_PASSWORD:-}/\" \\\n  \
              \       > /synapse/config/conf.d/secrets.yaml\n\nexec python -B -m synapse.app.homeserver\
              \ \\\n            -c /synapse/config/homeserver.yaml \\\n          \
              \  -c /synapse/config/conf.d/\n"
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-password
                  name: synapse-env
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-auth
          image: ghcr.io/element-hq/synapse:v1.146.0
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /health
              port: http
          name: synapse
          ports:
            - containerPort: 8008
              name: http
              protocol: TCP
            - containerPort: 9093
              name: replication
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /health
              port: http
          resources: {}
          securityContext: {}
          startupProbe:
            failureThreshold: 12
            httpGet:
              path: /health
              port: http
          volumeMounts:
            - mountPath: /synapse/config
              name: config
            - mountPath: /synapse/config/conf.d
              name: tmpconf
            - mountPath: /synapse/secrets
              name: secrets
            - mountPath: /synapse/keys
              name: signingkey
            - mountPath: /synapse/data
              name: media
            - mountPath: /tmp
              name: tmpdir
            - mountPath: /synapse/config/conf.d/mautrix-whatsapp-registration.yaml
              name: mautrix-whatsapp-registration
              readOnly: true
              subPath: mautrix-whatsapp-registration.yaml
            - mountPath: /synapse/config/conf.d/mautrix-discord-registration.yaml
              name: mautrix-discord-registration
              readOnly: true
              subPath: mautrix-discord-registration.yaml
            - mountPath: /synapse/config/conf.d/mautrix-slack-registration.yaml
              name: mautrix-slack-registration
              readOnly: true
              subPath: mautrix-slack-registration.yaml
      securityContext: {}
      serviceAccountName: default
      volumes:
        - configMap:
            name: synapse-matrix-synapse
          name: config
        - name: secrets
          secret:
            secretName: synapse-matrix-synapse
        - name: signingkey
          secret:
            items:
              - key: signing.key
                path: signing.key
            secretName: synapse-signingkey
        - emptyDir: {}
          name: tmpconf
        - emptyDir: {}
          name: tmpdir
        - name: media
          persistentVolumeClaim:
            claimName: synapse-matrix-synapse
        - name: mautrix-whatsapp-registration
          secret:
            items:
              - key: registration.yaml
                path: mautrix-whatsapp-registration.yaml
            secretName: mautrix-whatsapp-registration
        - name: mautrix-discord-registration
          secret:
            items:
              - key: registration.yaml
                path: mautrix-discord-registration.yaml
            secretName: mautrix-discord-registration
        - name: mautrix-slack-registration
          secret:
            items:
              - key: registration.yaml
                path: mautrix-slack-registration.yaml
            secretName: mautrix-slack-registration
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: signingkey-job
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-signingkey-job
  namespace: apps
spec:
  backoffLimit: 1
  completions: 1
  parallelism: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/component: signingkey-job
        app.kubernetes.io/instance: synapse
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: matrix-synapse
        app.kubernetes.io/version: 1.146.0
        helm.sh/chart: matrix-synapse-3.12.19
    spec:
      containers:
        - command:
            - sh
            - -c
            - "echo \"Generating signing key...\"\nif which generate_signing_key.py\
              \ >/dev/null; then\n  generate_signing_key.py -o /synapse/keys/signing.key\n\
              else\n  generate_signing_key -o /synapse/keys/signing.key\nfi\n"
          image: matrixdotorg/synapse:latest
          imagePullPolicy: IfNotPresent
          name: signing-key-generate
          resources: {}
          securityContext: {}
          volumeMounts:
            - mountPath: /synapse/keys
              name: matrix-synapse-keys
        - command:
            - sh
            - -c
            - 'printf "Checking rights to update secret... "

              kubectl auth can-i update secret/${SECRET_NAME}

              /scripts/signing-key.sh

              '
          env:
            - name: SECRET_NAME
              value: synapse-signingkey
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          name: signing-key-upload
          resources: {}
          securityContext: {}
          volumeMounts:
            - mountPath: /scripts
              name: scripts
              readOnly: true
            - mountPath: /synapse/keys
              name: matrix-synapse-keys
              readOnly: true
      restartPolicy: Never
      securityContext: {}
      serviceAccount: synapse-signingkey-job
      volumes:
        - configMap:
            defaultMode: 493
            name: synapse-matrix-synapse-scripts
          name: scripts
        - emptyDir: {}
          name: matrix-synapse-keys
  ttlSecondsAfterFinished: 0
---
apiVersion: v1
data:
  homeserver.yaml: "# NOTE:\n# Secrets are stored in separate configs to better fit\
    \ K8s concepts\n\n## Server ##\n\nserver_name: \"josevictor.me\"\npublic_baseurl:\
    \ \"https://matrix.josevictor.me\"\npid_file: /homeserver.pid\nweb_client: False\n\
    soft_file_limit: 0\nlog_config: \"/synapse/config/log.yaml\"\nreport_stats: false\n\
    \ninstance_map:\n  main:\n    host: synapse-replication\n    port: 9093\n\n##\
    \ Ports ##\n\nlisteners:\n  - port: 8008\n    tls: false\n    bind_addresses:\
    \ [\"::\"]\n    type: http\n    x_forwarded: true\n\n    resources:\n      - names:\
    \ \n          - client\n          - federation\n        compress: false\n\n  -\
    \ port: 9090\n    tls: false\n    bind_addresses: [\"::\"]\n    type: http\n\n\
    \    resources:\n      - names: [metrics]\n        compress: false\n\n  - port:\
    \ 9093\n    tls: false\n    bind_addresses: [\"::\"]\n    type: http\n\n    resources:\n\
    \      - names: [replication]\n        compress: false\n\n## Files ##\n\nmedia_store_path:\
    \ \"/synapse/data/media\"\nuploads_path: \"/synapse/data/uploads\"\n\n## Registration\
    \ ##\n\nenable_registration: false\n\n## Metrics ###\n\nenable_metrics: true\n\
    \n## Signing Keys ##\n\nsigning_key_path: \"/synapse/keys/signing.key\"\n\n# The\
    \ trusted servers to download signing keys from.\ntrusted_key_servers:\n  - server_name:\
    \ matrix.org\n\n## Workers ##\n\n## Extra config ##\n\napp_service_config_files:\n\
    - /synapse/config/conf.d/mautrix-whatsapp-registration.yaml\n- /synapse/config/conf.d/mautrix-discord-registration.yaml\n\
    - /synapse/config/conf.d/mautrix-slack-registration.yaml\nrc_admin_redaction:\n\
    \  burst_count: 200\n  per_second: 100\nrc_invites:\n  per_issuer:\n    burst_count:\
    \ 100\n    per_second: 50\n  per_room:\n    burst_count: 100\n    per_second:\
    \ 50\n  per_user:\n    burst_count: 100\n    per_second: 50\nrc_joins:\n  local:\n\
    \    burst_count: 100\n    per_second: 50\n  remote:\n    burst_count: 20\n  \
    \  per_second: 10\nrc_joins_per_room:\n  burst_count: 100\n  per_second: 50\n\
    rc_message:\n  burst_count: 100\n  per_second: 50\n"
  log.yaml: "version: 1\nformatters:\n  precise:\n    format: '%(asctime)s - %(name)s\
    \ - %(lineno)d - %(levelname)s - %(request)s- %(message)s'\nfilters:\n  context:\n\
    \    (): synapse.util.logcontext.LoggingContextFilter\n    request: \"\"\nhandlers:\n\
    \  console:\n    class: logging.StreamHandler\n    formatter: precise\n    filters:\
    \ [context]\n    level: INFO\nloggers:\n    synapse:\n      level: INFO\nroot:\n\
    \    level: INFO\n    handlers: [console]\n"
kind: ConfigMap
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
---
apiVersion: v1
data:
  signing-key.sh: "#!/bin/sh\n\nset -eu\n\ncheck_key() {\n  set +e\n\n  echo \"Checking\
    \ for existing signing key...\"\n  key=\"$(kubectl get secret \"$SECRET_NAME\"\
    \ -o jsonpath=\"{.data['signing\\.key']}\" 2> /dev/null)\"\n  [ $? -ne 0 ] &&\
    \ return 1\n  [ -z \"$key\" ] && return 2\n  return 0\n}\n\ncreate_key() {\n \
    \ echo \"Waiting for new signing key to be generated...\"\n  begin=$(date +%s)\n\
    \  end=$((begin + 300)) # 5 minutes\n  while true; do\n    [ -f /synapse/keys/signing.key\
    \ ] && return 0\n    [ \"$(date +%s)\" -gt $end ] && return 1\n    sleep 5\n \
    \ done\n}\n\nstore_key() {\n  echo \"Storing signing key in Kubernetes secret...\"\
    \n  kubectl patch secret \"$SECRET_NAME\" -p \"{\\\"data\\\":{\\\"signing.key\\\
    \":\\\"$(base64 /synapse/keys/signing.key | tr -d '\\n')\\\"}}\"\n}\n\nif check_key;\
    \ then\n  echo \"Key already in place, exiting.\"\n  exit\nfi\n\nif ! create_key;\
    \ then\n  echo \"Timed out waiting for a signing key to appear.\"\n  exit 1\n\
    fi\n\nstore_key\n"
kind: ConfigMap
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse-scripts
  namespace: apps
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: rook-ceph-block
---
apiVersion: v1
kind: Pod
metadata:
  annotations:
    helm.sh/hook: test-success
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse-test-connection
  namespace: apps
spec:
  containers:
    - args:
        - synapse-matrix-synapse:8008/_matrix/client/versions
      command:
        - wget
      image: busybox
      name: wget
  restartPolicy: Never
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
stringData:
  config.yaml: "## Registration ##\n\nregistration_shared_secret: \"KsLCHuSPWGhZIsIxmsE6KJrg\"\
    \n\n## API Configuration ##\n\n## Database configuration ##\n\ndatabase:\n  name:\
    \ \"psycopg2\"\n  args:\n    user: \"postgres\"\n    password: \"@@POSTGRES_PASSWORD@@\"\
    \n    database: \"synapse\"\n    host: \"postgresql-18-hl\"\n    port: 5432\n\
    \    sslmode: \"prefer\"\n    cp_min: 5\n    cp_max: 10\n    \n\n## Redis configuration\
    \ ##\n\nredis:\n  enabled: true\n  host: \"redis-headless\"\n  port: 6379\n  password:\
    \ \"@@REDIS_PASSWORD@@\"\n"
---
apiVersion: v1
kind: Secret
metadata:
  annotations:
    argocd.argoproj.io/hook: Skip
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: never
    helm.sh/resource-policy: keep
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: signingkey-job
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-signingkey
  namespace: apps
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
spec:
  ports:
    - name: http
      port: 8008
      protocol: TCP
      targetPort: http
  selector:
    app.kubernetes.io/component: synapse
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/name: matrix-synapse
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-replication
  namespace: apps
spec:
  ports:
    - name: replication
      port: 9093
      protocol: TCP
      targetPort: replication
  selector:
    app.kubernetes.io/component: synapse
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/name: matrix-synapse
  type: ClusterIP
---
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: signingkey-job
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-signingkey-job
  namespace: apps
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: cloudflare-issuer
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-matrix-synapse
  namespace: apps
spec:
  ingressClassName: cilium
  rules:
    - host: matrix.josevictor.me
      http:
        paths:
          - backend:
              service:
                name: synapse-matrix-synapse
                port:
                  number: 8008
            path: /_matrix
            pathType: Prefix
          - backend:
              service:
                name: synapse-matrix-synapse
                port:
                  number: 8008
            path: /_synapse
            pathType: Prefix
  tls:
    - hosts:
        - matrix.josevictor.me
      secretName: wildcard-tls
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: signingkey-job
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-signingkey-job
  namespace: apps
rules:
  - apiGroups:
      - ''
    resourceNames:
      - synapse-signingkey
    resources:
      - secrets
    verbs:
      - get
      - update
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-delete-policy: hook-succeeded
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  labels:
    app.kubernetes.io/component: signingkey-job
    app.kubernetes.io/instance: synapse
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: matrix-synapse
    app.kubernetes.io/version: 1.146.0
    helm.sh/chart: matrix-synapse-3.12.19
  name: synapse-signingkey-job
  namespace: apps
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: synapse-signingkey-job
subjects:
  - kind: ServiceAccount
    name: synapse-signingkey-job
    namespace: apps
