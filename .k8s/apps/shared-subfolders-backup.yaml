apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-backup
  namespace: apps
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          containers:
            - args:
                - "set -euo pipefail\n\nDATE=\"$(date +%Y-%m-%d)\"\nTIMESTAMP=\"$(date\
                  \ +%Y%m%d_%H%M%S)\"\nMANIFEST_FILE=\"manifest-$DATE.json\"\n\nSOURCE_ROOT=\"\
                  /shared\"\n\necho \"=== Starting shared subfolders backup (rclone\
                  \ sync) ===\"\necho \"Date: $DATE\"\necho \"Timestamp: $TIMESTAMP\"\
                  \necho \"Folders to backup: notetaking images backups\"\necho \"\
                  Destination: s3:homelab-backup-shared/\"\n\n# Create rclone config\n\
                  mkdir -p \"$HOME/.config/rclone\"\ncat > \"$HOME/.config/rclone/rclone.conf\"\
                  \ <<EOF\n[minio]\ntype = s3\nprovider = Minio\nenv_auth = false\n\
                  access_key_id = $AWS_ACCESS_KEY_ID\nsecret_access_key = $AWS_SECRET_ACCESS_KEY\n\
                  endpoint = $MINIO_ENDPOINT\nregion = us-east-1\nforce_path_style\
                  \ = true\nEOF\n\n# Generate manifest of files\necho \"Generating\
                  \ manifest...\"\nWORKDIR=\"/tmp/backup-$TIMESTAMP\"\nmkdir -p \"\
                  $WORKDIR\"\ncd \"$WORKDIR\"\n\necho \"{\" > \"$MANIFEST_FILE\"\n\
                  echo \"  \\\"backup_date\\\": \\\"$DATE\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"timestamp\\\": \\\"$TIMESTAMP\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"source_root\\\": \\\"/shared\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"method\\\": \\\"rclone-sync\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"destination\\\": \\\"s3:homelab-backup-shared/current/\\\
                  \",\" >> \"$MANIFEST_FILE\"\necho \"  \\\"folders\\\": [\\\"notetaking\\\
                  \", \\\"images\\\", \\\"backups\\\"],\" >> \"$MANIFEST_FILE\"\n\
                  echo \"  \\\"files\\\": [\" >> \"$MANIFEST_FILE\"\n\nFIRST=true\n\
                  for folder in notetaking images backups; do\n  if [ -d \"$SOURCE_ROOT/$folder\"\
                  \ ]; then\n    while IFS= read -r -d $'\\0' file; do\n      SIZE=\"\
                  $(stat -c%s \"$file\" 2>/dev/null || echo 0)\"\n      MTIME=\"$(stat\
                  \ -c%Y \"$file\" 2>/dev/null || echo 0)\"\n      RELPATH=\"${file#$SOURCE_ROOT/}\"\
                  \n      if [ \"$FIRST\" = true ]; then\n        FIRST=false\n  \
                  \    else\n        echo \",\" >> \"$MANIFEST_FILE\"\n      fi\n\
                  \      echo -n \"        {\\\"path\\\": \\\"$RELPATH\\\", \\\"size\\\
                  \": $SIZE, \\\"mtime\\\": $MTIME}\" >> \"$MANIFEST_FILE\"\n    done\
                  \ < <(find \"$SOURCE_ROOT/$folder\" -type f ! -name \".DS_Store\"\
                  \ ! -name \"Thumbs.db\" -print0 2>/dev/null)\n  fi\ndone\n\necho\
                  \ \"\" >> \"$MANIFEST_FILE\"\necho \"      ],\" >> \"$MANIFEST_FILE\"\
                  \necho \"      \\\"exclusions\\\": [\\\".DS_Store\\\", \\\"Thumbs.db\\\
                  \"]\" >> \"$MANIFEST_FILE\"\necho \"    }\" >> \"$MANIFEST_FILE\"\
                  \n\n# Ensure bucket exists\necho \"Ensuring bucket exists...\"\n\
                  rclone mkdir \"minio:homelab-backup-shared\"\n\n# Sync each folder\
                  \ individually with filters\necho \"Starting rclone sync...\"\n\
                  for folder in notetaking images backups; do\n  if [ -d \"$SOURCE_ROOT/$folder\"\
                  \ ]; then\n    echo \"Syncing folder: $folder\"\n    rclone sync\
                  \ \"$SOURCE_ROOT/$folder\" \"minio:homelab-backup-shared/current/$folder/\"\
                  \ \\\n      --exclude \".DS_Store\" \\\n      --exclude \"Thumbs.db\"\
                  \ \\\n      --fast-list \\\n      --transfers 4 \\\n      --checksum\
                  \ \\\n      --stats-one-line \\\n      --stats 30s \\\n      --log-level\
                  \ INFO\n  else\n    echo \"Warning: folder $folder not found, skipping\"\
                  \n  fi\ndone\n\n# Upload manifest\necho \"Uploading manifest...\"\
                  \nrclone copy \"$MANIFEST_FILE\" \"minio:homelab-backup-shared/manifests/\"\
                  \n\n# Clean up\nrm -rf \"$WORKDIR\"\n\necho \"=== Backup completed\
                  \ successfully ===\"\necho \"Destination: s3:homelab-backup-shared/current/\"\
                  \necho \"Manifest: s3:homelab-backup-shared/manifests/$MANIFEST_FILE\"\
                  \n"
              command:
                - bash
                - -c
              env:
                - name: MINIO_ENDPOINT
                  value: http://10.10.10.209:9000
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      key: AWS_ACCESS_KEY_ID
                      name: shared-subfolders-backup-s3-credentials
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      key: AWS_SECRET_ACCESS_KEY
                      name: shared-subfolders-backup-s3-credentials
              image: ghcr.io/josevictorferreira/backup-toolbox@sha256:10c2e55a28316965b53fc82a7bd34133293c09c8cdc1292a3f0eec3fb06cad44
              name: backup
              resources:
                limits:
                  cpu: 1000m
                  ephemeral-storage: 512Mi
                  memory: 1Gi
                requests:
                  cpu: 100m
                  ephemeral-storage: 256Mi
                  memory: 256Mi
              volumeMounts:
                - mountPath: /shared
                  name: shared-storage
                  readOnly: true
          imagePullSecrets:
            - name: ghcr-registry-secret
          restartPolicy: OnFailure
          volumes:
            - name: shared-storage
              persistentVolumeClaim:
                claimName: cephfs-shared-storage-root
  schedule: 0 1 * * *
  successfulJobsHistoryLimit: 3
  timeZone: America/Sao_Paulo
