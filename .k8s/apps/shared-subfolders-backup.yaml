apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-backup
  namespace: apps
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          containers:
            - args:
                - "set -euo pipefail\n\nDATE=\"$(date +%Y-%m-%d)\"\nTIMESTAMP=\"$(date\
                  \ +%Y%m%d_%H%M%S)\"\nARCHIVE_NAME=\"shared-$DATE\"\nARCHIVE_FILE=\"\
                  $ARCHIVE_NAME.tar.zst\"\nSHA256_FILE=\"$ARCHIVE_FILE.sha256\"\n\
                  MANIFEST_FILE=\"$ARCHIVE_NAME.manifest.json\"\n\nSOURCE_ROOT=\"\
                  /shared\"\nDEST_PREFIX=\"$DATE\"\n\necho \"=== Starting shared subfolders\
                  \ backup ===\"\necho \"Date: $DATE\"\necho \"Timestamp: $TIMESTAMP\"\
                  \necho \"Folders to backup: notetaking images backups\"\n\nWORKDIR=\"\
                  /tmp/backup-$TIMESTAMP\"\nmkdir -p \"$WORKDIR\"\ncd \"$WORKDIR\"\
                  \n\necho \"Creating manifest...\"\necho \"{\" > \"$MANIFEST_FILE\"\
                  \necho \"  \\\"backup_date\\\": \\\"$DATE\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"timestamp\\\": \\\"$TIMESTAMP\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"source_root\\\": \\\"/shared\\\",\" >> \"$MANIFEST_FILE\"\
                  \necho \"  \\\"folders\\\": [\\\"notetaking\\\", \\\"images\\\"\
                  , \\\"backups\\\"],\" >> \"$MANIFEST_FILE\"\necho \"  \\\"files\\\
                  \": [\" >> \"$MANIFEST_FILE\"\n\nFIRST=true\nfor folder in notetaking\
                  \ images backups; do\n  if [ -d \"$SOURCE_ROOT/$folder\" ]; then\n\
                  \    find \"$SOURCE_ROOT/$folder\" -type f ! -name \".DS_Store\"\
                  \ ! -name \"Thumbs.db\" -print0 2>/dev/null | while IFS= read -r\
                  \ -d ''' file; do\n      SIZE=\"$(stat -c%s \"'''file\" 2>/dev/null\
                  \ || echo 0)\"\n      MTIME=\"$(stat -c%Y \"'''file\" 2>/dev/null\
                  \ || echo 0)\"\n      RELPATH=\"'''{file#'''SOURCE_ROOT/}\"\n  \
                  \    if [ \"$FIRST\" = true ]; then\n        FIRST=false\n     \
                  \ else\n        echo \",\" >> \"$MANIFEST_FILE\"\n      fi\n   \
                  \   echo -n \"        {\\\"path\\\": \\\"$RELPATH\\\", \\\"size\\\
                  \": $SIZE, \\\"mtime\\\": $MTIME}\" >> \"$MANIFEST_FILE\"\n    done\n\
                  \  fi\ndone\n\necho \"\" >> \"$MANIFEST_FILE\"\necho \"      ],\"\
                  \ >> \"$MANIFEST_FILE\"\necho \"      \\\"exclusions\\\": [\\\"\
                  .DS_Store\\\", \\\"Thumbs.db\\\"]\" >> \"$MANIFEST_FILE\"\necho\
                  \ \"    }\" >> \"$MANIFEST_FILE\"\n\necho \"Creating tar.zst archive...\"\
                  \ntar --zstd -cf \"$ARCHIVE_FILE\" \\\n  --exclude=\".DS_Store\"\
                  \ \\\n  --exclude=\"Thumbs.db\" \\\n  -C \"$SOURCE_ROOT\" \\\n \
                  \ notetaking images backups\n\necho \"Generating SHA256 checksum...\"\
                  \nsha256sum \"$ARCHIVE_FILE\" > \"$SHA256_FILE\"\n\necho \"Archive\
                  \ size: $(du -h \"$ARCHIVE_FILE\" | cut -f1)\"\n\necho \"Uploading\
                  \ to MinIO...\"\nmc alias set shared \"$MINIO_ENDPOINT\" \"$AWS_ACCESS_KEY_ID\"\
                  \ \"$AWS_SECRET_ACCESS_KEY\"\nmc mb --ignore-existing \"shared/homelab-backup-shared\"\
                  \n\nmc cp \"$ARCHIVE_FILE\" \"shared/homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE.tmp\"\
                  \nmc mv \"shared/homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE.tmp\"\
                  \ \"shared/homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE\"\n\n\
                  mc cp \"$SHA256_FILE\" \"shared/homelab-backup-shared/$DEST_PREFIX/$SHA256_FILE.tmp\"\
                  \nmc mv \"shared/homelab-backup-shared/$DEST_PREFIX/$SHA256_FILE.tmp\"\
                  \ \"shared/homelab-backup-shared/$DEST_PREFIX/$SHA256_FILE\"\n\n\
                  mc cp \"$MANIFEST_FILE\" \"shared/homelab-backup-shared/$DEST_PREFIX/$MANIFEST_FILE.tmp\"\
                  \nmc mv \"shared/homelab-backup-shared/$DEST_PREFIX/$MANIFEST_FILE.tmp\"\
                  \ \"shared/homelab-backup-shared/$DEST_PREFIX/$MANIFEST_FILE\"\n\
                  \necho \"Verifying uploads...\"\nmc stat \"shared/homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE\"\
                  \nmc stat \"shared/homelab-backup-shared/$DEST_PREFIX/$SHA256_FILE\"\
                  \nmc stat \"shared/homelab-backup-shared/$DEST_PREFIX/$MANIFEST_FILE\"\
                  \n\necho \"Verifying checksum...\"\nmc cat \"shared/homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE\"\
                  \ | sha256sum -c \"$SHA256_FILE\"\n\nrm -rf \"$WORKDIR\"\n\necho\
                  \ \"=== Backup completed successfully ===\"\necho \"Archive: s3://homelab-backup-shared/$DEST_PREFIX/$ARCHIVE_FILE\"\
                  \n"
              command:
                - bash
                - -c
              env:
                - name: MINIO_ENDPOINT
                  value: http://10.10.10.209:9000
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      key: AWS_ACCESS_KEY_ID
                      name: shared-subfolders-backup-s3-credentials
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      key: AWS_SECRET_ACCESS_KEY
                      name: shared-subfolders-backup-s3-credentials
              image: ghcr.io/josevictorferreira/backup-toolbox@sha256:143dc0beafb3865fdd37d5a85bb814654063061af96e610ea53a2e9900c2da55
              name: backup
              resources:
                limits:
                  cpu: 1000m
                  ephemeral-storage: 10Gi
                  memory: 1Gi
                requests:
                  cpu: 100m
                  ephemeral-storage: 2Gi
                  memory: 256Mi
              volumeMounts:
                - mountPath: /shared
                  name: shared-storage
                  readOnly: true
          imagePullSecrets:
            - name: ghcr-registry-secret
          restartPolicy: OnFailure
          volumes:
            - name: shared-storage
              persistentVolumeClaim:
                claimName: cephfs-shared-storage-root
  schedule: 0 1 * * *
  successfulJobsHistoryLimit: 3
  timeZone: America/Sao_Paulo
