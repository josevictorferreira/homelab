apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: proton-drive-auth-bootstrap
  namespace: apps
spec:
  template:
    spec:
      containers:
        - args:
            - 'echo "=============================================="

              echo "Proton Drive Auth Bootstrap Job"

              echo "=============================================="

              echo ""

              echo "This job is waiting for interactive authentication."

              echo ""

              echo "To authenticate, run:"

              echo "  kubectl attach -it job/proton-drive-auth-bootstrap -n apps"

              echo ""

              echo "Then follow the prompts to log in with your Proton account."

              echo ""

              echo "After successful authentication, credentials will be"

              echo "stored in /config/proton-drive-sync/credentials.enc"

              echo ""

              echo "=============================================="

              echo "Waiting for interactive session..."

              echo "=============================================="

              echo ""


              # Keep container running for interactive attach

              exec sleep infinity

              '
          command:
            - sh
            - -c
          env:
            - name: KEYRING_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: KEYRING_PASSWORD
                  name: shared-subfolders-proton-sync-config
          image: ghcr.io/damianb-bitflipper/proton-drive-sync:0.2.3-beta.3
          name: proton-drive-auth-bootstrap
          resources:
            limits:
              cpu: 200m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 128Mi
          stdin: true
          tty: true
          volumeMounts:
            - mountPath: /config/proton-drive-sync
              name: proton-config
            - mountPath: /state/proton-drive-sync
              name: proton-state
      restartPolicy: Never
      volumes:
        - name: proton-config
          persistentVolumeClaim:
            claimName: shared-subfolders-proton-sync-config
        - name: proton-state
          persistentVolumeClaim:
            claimName: shared-subfolders-proton-sync-state
  ttlSecondsAfterFinished: 86400
