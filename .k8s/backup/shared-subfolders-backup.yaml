apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    kubenix/k8s-version: '1.32'
    kubenix/project-name: ze-homelab
  name: shared-subfolders-backup
  namespace: backup
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          containers:
            - args:
                - "    set -euo pipefail\n\n    DATE=\"$(date +%Y-%m-%d)\"\n    TIMESTAMP=\"\
                  $(date +%Y%m%d_%H%M%S)\"\n    MANIFEST_FILE=\"manifest-$DATE.json\"\
                  \n\n    SOURCE_ROOT=\"/shared\"\n\n    echo \"=== Starting shared\
                  \ subfolders backup (rclone sync) ===\"\n    echo \"Date: $DATE\"\
                  \n    echo \"Timestamp: $TIMESTAMP\"\n    echo \"Folders to backup:\
                  \ notetaking images backups\"\n    echo \"Destination: s3:homelab-backup-shared/\"\
                  \n\n    # Create rclone config\n    mkdir -p \"$HOME/.config/rclone\"\
                  \n    \n    # Trim any whitespace/newlines from credentials\n  \
                  \  ACCESS_KEY=\"$(echo -n \"$AWS_ACCESS_KEY_ID\" | tr -d '\\n\\\
                  r')\"\n    SECRET_KEY=\"$(echo -n \"$AWS_SECRET_ACCESS_KEY\" | tr\
                  \ -d '\\n\\r')\"\n    \n    cat > \"$HOME/.config/rclone/rclone.conf\"\
                  \ <<EOF\n[minio]\ntype = s3\nprovider = Minio\nenv_auth = false\n\
                  access_key_id = $ACCESS_KEY\nsecret_access_key = $SECRET_KEY\nendpoint\
                  \ = $MINIO_ENDPOINT\nregion = sa-east-1\nforce_path_style = true\n\
                  EOF\n\n    # Generate manifest of files\n    echo \"Generating manifest...\"\
                  \n    WORKDIR=\"/tmp/backup-$TIMESTAMP\"\n    mkdir -p \"$WORKDIR\"\
                  \n    cd \"$WORKDIR\"\n\n    echo \"{\" > \"$MANIFEST_FILE\"\n \
                  \   echo \"  \\\"backup_date\\\": \\\"$DATE\\\",\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"  \\\"timestamp\\\": \\\"$TIMESTAMP\\\",\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"  \\\"source_root\\\": \\\"/shared\\\",\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"  \\\"method\\\": \\\"rclone-sync\\\",\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"  \\\"destination\\\": \\\"s3:homelab-backup-shared/current/\\\
                  \",\" >> \"$MANIFEST_FILE\"\n    echo \"  \\\"folders\\\": [\\\"\
                  notetaking\\\", \\\"images\\\", \\\"backups\\\"],\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"  \\\"files\\\": [\" >> \"$MANIFEST_FILE\"\n\n    FIRST=true\n\
                  \    for folder in notetaking images backups; do\n      if [ -d\
                  \ \"$SOURCE_ROOT/$folder\" ]; then\n        while IFS= read -r -d\
                  \ $'\\0' file; do\n          SIZE=\"$(stat -c%s \"$file\" 2>/dev/null\
                  \ || echo 0)\"\n          MTIME=\"$(stat -c%Y \"$file\" 2>/dev/null\
                  \ || echo 0)\"\n          RELPATH=\"${file#$SOURCE_ROOT/}\"\n  \
                  \        if [ \"$FIRST\" = true ]; then\n            FIRST=false\n\
                  \          else\n            echo \",\" >> \"$MANIFEST_FILE\"\n\
                  \          fi\n          echo -n \"        {\\\"path\\\": \\\"$RELPATH\\\
                  \", \\\"size\\\": $SIZE, \\\"mtime\\\": $MTIME}\" >> \"$MANIFEST_FILE\"\
                  \n        done < <(find \"$SOURCE_ROOT/$folder\" -type f ! -name\
                  \ \".DS_Store\" ! -name \"Thumbs.db\" -print0 2>/dev/null)\n   \
                  \   fi\n    done\n\n    echo \"\" >> \"$MANIFEST_FILE\"\n    echo\
                  \ \"      ],\" >> \"$MANIFEST_FILE\"\n    echo \"      \\\"exclusions\\\
                  \": [\\\".DS_Store\\\", \\\"Thumbs.db\\\"]\" >> \"$MANIFEST_FILE\"\
                  \n    echo \"    }\" >> \"$MANIFEST_FILE\"\n\n    # Ensure bucket\
                  \ exists\n    echo \"Ensuring bucket exists...\"\n    rclone mkdir\
                  \ \"minio:homelab-backup-shared\"\n\n    # Sync each folder individually\
                  \ with filters\n    echo \"Starting rclone sync...\"\n    for folder\
                  \ in notetaking images backups; do\n      if [ -d \"$SOURCE_ROOT/$folder\"\
                  \ ]; then\n        echo \"Syncing folder: $folder\"\n        rclone\
                  \ sync \"$SOURCE_ROOT/$folder\" \"minio:homelab-backup-shared/current/$folder/\"\
                  \ \\\n          --exclude \".DS_Store\" \\\n          --exclude\
                  \ \"Thumbs.db\" \\\n          --fast-list \\\n          --transfers\
                  \ 4 \\\n          --checksum \\\n          --stats-one-line \\\n\
                  \          --stats 30s \\\n          --log-level INFO\n      else\n\
                  \        echo \"Warning: folder $folder not found, skipping\"\n\
                  \      fi\n    done\n\n    # Upload manifest\n    echo \"Uploading\
                  \ manifest...\"\n    rclone copy \"$MANIFEST_FILE\" \"minio:homelab-backup-shared/manifests/\"\
                  \n\n    # Clean up\n    rm -rf \"$WORKDIR\"\n\n    echo \"=== Backup\
                  \ completed successfully ===\"\n    echo \"Destination: s3:homelab-backup-shared/current/\"\
                  \n    echo \"Manifest: s3:homelab-backup-shared/manifests/$MANIFEST_FILE\"\
                  \n"
              command:
                - bash
                - -c
              env:
                - name: MINIO_ENDPOINT
                  value: http://10.10.10.209:9000
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      key: AWS_ACCESS_KEY_ID
                      name: shared-subfolders-backup-s3-credentials
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      key: AWS_SECRET_ACCESS_KEY
                      name: shared-subfolders-backup-s3-credentials
              image: ghcr.io/josevictorferreira/backup-toolbox@sha256:08bda3ee3383b093cc0ed74d42ed9b167ecb92dd7c01e090a542d0a75dec8abb
              name: backup
              resources:
                limits:
                  cpu: 1000m
                  ephemeral-storage: 512Mi
                  memory: 1Gi
                requests:
                  cpu: 100m
                  ephemeral-storage: 256Mi
                  memory: 256Mi
              volumeMounts:
                - mountPath: /shared
                  name: shared-storage
                  readOnly: true
          imagePullSecrets:
            - name: ghcr-registry-secret
          restartPolicy: OnFailure
          volumes:
            - name: shared-storage
              persistentVolumeClaim:
                claimName: cephfs-shared-storage-root
  schedule: 0 1 * * *
  successfulJobsHistoryLimit: 3
  timeZone: America/Sao_Paulo
